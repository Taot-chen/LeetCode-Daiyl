## 写文件时进程宕机数据会丢失吗

In One Word:

* 数据丢失的根本原因：缓冲机制与异步回写​
* 当进程调用 `write()` 写入文件时，数据首先进入内核的 ​​Page Cache​​（内存缓冲区），而非直接落盘。此时数据标记为*脏页*（Dirty Page），由内核异步回写到磁盘。
* 若进程在数据仍停留在 Page Cache 时崩溃，且系统未及时触发磁盘写入，则这部分数据会因内存断电而丢失
* 脏页异步回写触发机制：
    * 当脏页占比超过 dirty_ratio（默认30%）或 dirty_background_ratio（默认10%）时，内核启动后台线程回写
    * 脏页存活超过 dirty_expire_interval（默认30秒）会被回写
    * 调用 fsync()、fdatasync() 或 sync() 可强制立即落盘
* 写入策略：
    * 异步写入（默认），会使用 page cache，高性能但高风险
    * ​​同步写入​​：不使用 page cache，直接写入硬盘，数据落盘后才返回，性能差，安全性高

